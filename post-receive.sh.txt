#!/bin/sh

#
# Enables git-push-to-deploy
#   via: http://blog.bacongobbler.com/2013/07/09/blog-deployment-setup/
#
# On the remote machine:
#
#   $ ssh user@server.com
#   $ mkdir spacebase.git && cd spacebase.git
#   $ git init --bare
#
# ... then, copy this script into `spacebase.git/hooks/post-receive`
#
# On your local machine, to deploy:
#
#   $ git remote add deploy username@server:/var/www/spacebase.space150.com/spacebase.git
#   $ git push deploy master
#

GIT_REPO=/var/www/spacebase.space150.com/spacebase.git
TMP_GIT_CLONE=/tmp/spacebase.space150.com
PUBLIC_WWW=/var/www/spacebase.space150.com/public_html

while read oldrev newrev refname
do
    branch=$(git rev-parse --symbolic --abbrev-ref $refname)

    # We only want to deal with the master branch
    if [ "$branch" = "master" ]; then
        git clone -b master $GIT_REPO $TMP_GIT_CLONE
        cd $TMP_GIT_CLONE
        bundle install --deployment
        bundle exec rake spacebase:build
        rm -rf $PUBLIC_WWW/*
        cp -R $TMP_GIT_CLONE/dist/* $PUBLIC_WWW
    fi

    rm -rf $TMP_GIT_CLONE
done
